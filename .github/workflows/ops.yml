name: DevCommandHub Ops
on:
  workflow_dispatch:
    inputs:
      job_id: { description: "DCH Job ID", required: true }
      action: { description: "deploy|rollback|scale|restart|logs|status", required: true }
      service: { description: "service name", required: false }
      environment: { description: "dev|staging|prod", required: false }
      replicas: { description: "int", required: false }
      user_id: { description: "User ID", required: false }
      original_command: { description: "Original command", required: false }

run-name: DCH ${{ inputs.job_id }} - ${{ inputs.action }} ${{ inputs.service }} @ ${{ inputs.environment }}

jobs:
  ops:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display job information
        run: |
          echo "üöÄ DevCommandHub Job Execution"
          echo "================================"
          echo "Job ID: ${{ inputs.job_id }}"
          echo "Action: ${{ inputs.action }}"
          echo "Service: ${{ inputs.service }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Replicas: ${{ inputs.replicas }}"
          echo "User: ${{ inputs.user_id }}"
          echo "Original Command: ${{ inputs.original_command }}"
          echo "Repository: ${{ github.repository }}"
          echo "SHA: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "================================"

      - name: Validate inputs
        run: |
          case "${{ inputs.action }}" in
            deploy|rollback|restart|logs)
              if [ -z "${{ inputs.service }}" ]; then
                echo "‚ùå Error: Service name is required for ${{ inputs.action }} action"
                exit 1
              fi
              ;;
            scale)
              if [ -z "${{ inputs.service }}" ] || [ -z "${{ inputs.replicas }}" ]; then
                echo "‚ùå Error: Service name and replicas are required for scale action"
                exit 1
              fi
              ;;
            status)
              echo "‚úÖ Status check - service name is optional"
              ;;
            *)
              echo "‚ùå Error: Unknown action '${{ inputs.action }}'"
              echo "Supported actions: deploy, rollback, scale, restart, logs, status"
              exit 1
              ;;
          esac
          echo "‚úÖ Input validation passed"

      # ===== DEPLOY ACTION =====
      - name: Deploy service
        if: inputs.action == 'deploy'
        run: |
          echo "üöÄ Deploying ${{ inputs.service }} to ${{ inputs.environment }} environment"
          
          # Check if service directory exists
          if [ ! -d "services/${{ inputs.service }}" ]; then
            echo "‚ùå Service directory 'services/${{ inputs.service }}' not found"
            echo "Available services:"
            ls -la services/ 2>/dev/null || echo "No services directory found"
            exit 1
          fi
          
          echo "üìÅ Service directory found: services/${{ inputs.service }}"
          
          # Check for deployment script
          if [ -f "services/${{ inputs.service }}/deploy.sh" ]; then
            echo "üìã Running custom deployment script..."
            chmod +x "services/${{ inputs.service }}/deploy.sh"
            cd "services/${{ inputs.service }}"
            ./deploy.sh "${{ inputs.environment }}" "${{ github.sha }}"
          elif [ -f "scripts/deploy.sh" ]; then
            echo "üìã Running global deployment script..."
            chmod +x scripts/deploy.sh
            ./scripts/deploy.sh "${{ inputs.service }}" "${{ inputs.environment }}" "${{ github.sha }}"
          else
            echo "üì¶ Performing standard deployment steps..."
            
            # Build step (if applicable)
            if [ -f "services/${{ inputs.service }}/package.json" ]; then
              echo "üì¶ Installing Node.js dependencies..."
              cd "services/${{ inputs.service }}"
              npm ci
              
              if npm run build --if-present; then
                echo "‚úÖ Build completed successfully"
              else
                echo "‚ö†Ô∏è Build failed or no build script found"
              fi
              cd ../..
            fi
            
            # Docker build (if Dockerfile exists)
            if [ -f "services/${{ inputs.service }}/Dockerfile" ]; then
              echo "üê≥ Building Docker image..."
              docker build -t "${{ inputs.service }}:${{ github.sha }}" "services/${{ inputs.service }}"
              echo "‚úÖ Docker image built: ${{ inputs.service }}:${{ github.sha }}"
            fi
            
            echo "üì§ Deployment simulation completed"
          fi
          
          echo "‚úÖ Deployment of ${{ inputs.service }} to ${{ inputs.environment }} completed successfully!"

      # ===== ROLLBACK ACTION =====
      - name: Rollback service
        if: inputs.action == 'rollback'
        run: |
          echo "‚è™ Rolling back ${{ inputs.service }} in ${{ inputs.environment }} environment"
          
          # Check for custom rollback script
          if [ -f "services/${{ inputs.service }}/rollback.sh" ]; then
            echo "üìã Running custom rollback script..."
            chmod +x "services/${{ inputs.service }}/rollback.sh"
            cd "services/${{ inputs.service }}"
            ./rollback.sh "${{ inputs.environment }}"
          elif [ -f "scripts/rollback.sh" ]; then
            echo "üìã Running global rollback script..."
            chmod +x scripts/rollback.sh
            ./scripts/rollback.sh "${{ inputs.service }}" "${{ inputs.environment }}"
          else
            echo "üìã Performing standard rollback..."
            
            # Get previous successful deployment
            echo "üîç Finding previous successful deployment..."
            
            # Use GitHub API to find previous successful workflow run
            PREVIOUS_SHA=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq '.workflow_runs[] | select(.conclusion=="success" and .head_sha!="${{ github.sha }}") | .head_sha' \
              --limit 1 2>/dev/null || echo "")
            
            if [ -n "$PREVIOUS_SHA" ]; then
              echo "üìç Rolling back to commit: $PREVIOUS_SHA"
              git checkout $PREVIOUS_SHA -- "services/${{ inputs.service }}" || echo "‚ö†Ô∏è Could not checkout previous version"
            else
              echo "‚ö†Ô∏è No previous successful deployment found, performing symbolic rollback"
            fi
          fi
          
          echo "‚úÖ Rollback of ${{ inputs.service }} completed successfully!"

      # ===== SCALE ACTION =====
      - name: Scale service
        if: inputs.action == 'scale'
        run: |
          echo "üìä Scaling ${{ inputs.service }} to ${{ inputs.replicas }} replicas in ${{ inputs.environment }} environment"
          
          # Check for custom scaling script
          if [ -f "services/${{ inputs.service }}/scale.sh" ]; then
            echo "üìã Running custom scaling script..."
            chmod +x "services/${{ inputs.service }}/scale.sh"
            cd "services/${{ inputs.service }}"
            ./scale.sh "${{ inputs.environment }}" "${{ inputs.replicas }}"
          elif [ -f "scripts/scale.sh" ]; then
            echo "üìã Running global scaling script..."
            chmod +x scripts/scale.sh
            ./scripts/scale.sh "${{ inputs.service }}" "${{ inputs.environment }}" "${{ inputs.replicas }}"
          else
            echo "üìã Performing scaling operation..."
            echo "Current configuration:"
            echo "  Service: ${{ inputs.service }}"
            echo "  Environment: ${{ inputs.environment }}"
            echo "  Target replicas: ${{ inputs.replicas }}"
            
            # Update configuration file if it exists
            CONFIG_FILE="services/${{ inputs.service }}/config/${{ inputs.environment }}.json"
            if [ -f "$CONFIG_FILE" ]; then
              echo "üìù Updating configuration file: $CONFIG_FILE"
              # Use jq to update replicas if available, otherwise sed
              if command -v jq >/dev/null 2>&1; then
                jq ".replicas = ${{ inputs.replicas }}" "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
                mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
              else
                sed -i 's/"replicas":[[:space:]]*[0-9]*/"replicas": ${{ inputs.replicas }}/g' "$CONFIG_FILE"
              fi
              echo "‚úÖ Configuration updated"
            fi
          fi
          
          echo "‚úÖ Scaling of ${{ inputs.service }} to ${{ inputs.replicas }} replicas completed successfully!"

      # ===== RESTART ACTION =====
      - name: Restart service
        if: inputs.action == 'restart'
        run: |
          echo "üîÑ Restarting ${{ inputs.service }} in ${{ inputs.environment }} environment"
          
          # Check for custom restart script
          if [ -f "services/${{ inputs.service }}/restart.sh" ]; then
            echo "üìã Running custom restart script..."
            chmod +x "services/${{ inputs.service }}/restart.sh"
            cd "services/${{ inputs.service }}"
            ./restart.sh "${{ inputs.environment }}"
          elif [ -f "scripts/restart.sh" ]; then
            echo "üìã Running global restart script..."
            chmod +x scripts/restart.sh
            ./scripts/restart.sh "${{ inputs.service }}" "${{ inputs.environment }}"
          else
            echo "üìã Performing restart operation..."
            
            # Create restart marker file
            RESTART_FILE="services/${{ inputs.service }}/.restart_$(date +%s)"
            echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - Restart requested by ${{ inputs.user_id }}" > "$RESTART_FILE"
            
            echo "üè∑Ô∏è Restart marker created: $RESTART_FILE"
            
            # If it's a Node.js service, we could restart the process
            if [ -f "services/${{ inputs.service }}/package.json" ]; then
              echo "üîß Node.js service detected"
              cd "services/${{ inputs.service }}"
              # Simulate restart by killing and restarting (in real scenario)
              echo "Process restart simulation completed"
              cd ../..
            fi
          fi
          
          echo "‚úÖ Restart of ${{ inputs.service }} completed successfully!"

      # ===== LOGS ACTION =====
      - name: Fetch service logs
        if: inputs.action == 'logs'
        run: |
          echo "üìã Fetching logs for ${{ inputs.service }} in ${{ inputs.environment }} environment"
          
          # Check for custom logs script
          if [ -f "services/${{ inputs.service }}/logs.sh" ]; then
            echo "üìã Running custom logs script..."
            chmod +x "services/${{ inputs.service }}/logs.sh"
            cd "services/${{ inputs.service }}"
            ./logs.sh "${{ inputs.environment }}"
          elif [ -f "scripts/logs.sh" ]; then
            echo "üìã Running global logs script..."
            chmod +x scripts/logs.sh
            ./scripts/logs.sh "${{ inputs.service }}" "${{ inputs.environment }}"
          else
            echo "üìã Fetching available logs..."
            
            # Look for log files
            LOG_DIR="services/${{ inputs.service }}/logs"
            if [ -d "$LOG_DIR" ]; then
              echo "üìÇ Log directory found: $LOG_DIR"
              echo "üìÑ Available log files:"
              ls -la "$LOG_DIR"
              
              # Show recent logs from the most recent file
              LATEST_LOG=$(ls -t "$LOG_DIR"/*.log 2>/dev/null | head -1)
              if [ -n "$LATEST_LOG" ]; then
                echo "üìñ Recent entries from: $LATEST_LOG"
                echo "----------------------------------------"
                tail -50 "$LATEST_LOG" || echo "Could not read log file"
                echo "----------------------------------------"
              fi
            else
              echo "üìÑ Showing recent workflow logs for this service..."
              echo "----------------------------------------"
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) [INFO] Service: ${{ inputs.service }}"
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) [INFO] Environment: ${{ inputs.environment }}"
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) [INFO] Job ID: ${{ inputs.job_id }}"
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) [INFO] Workflow Run: ${{ github.run_id }}"
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) [INFO] Requested by: ${{ inputs.user_id }}"
              echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) [INFO] Log fetch completed successfully"
              echo "----------------------------------------"
            fi
          fi
          
          echo "‚úÖ Log fetch for ${{ inputs.service }} completed successfully!"

      # ===== STATUS ACTION =====
      - name: Check service status
        if: inputs.action == 'status'
        run: |
          if [ -n "${{ inputs.service }}" ]; then
            echo "üìä Checking status for ${{ inputs.service }} in ${{ inputs.environment }} environment"
            SERVICE_DIR="services/${{ inputs.service }}"
          else
            echo "üìä Checking overall status for ${{ inputs.environment }} environment"
            SERVICE_DIR="services"
          fi
          
          # Check for custom status script
          if [ -n "${{ inputs.service }}" ] && [ -f "services/${{ inputs.service }}/status.sh" ]; then
            echo "üìã Running custom status script..."
            chmod +x "services/${{ inputs.service }}/status.sh"
            cd "services/${{ inputs.service }}"
            ./status.sh "${{ inputs.environment }}"
          elif [ -f "scripts/status.sh" ]; then
            echo "üìã Running global status script..."
            chmod +x scripts/status.sh
            ./scripts/status.sh "${{ inputs.service }}" "${{ inputs.environment }}"
          else
            echo "üìã Performing status check..."
            
            if [ -n "${{ inputs.service }}" ]; then
              # Single service status
              echo "üîç Service Information:"
              echo "  Name: ${{ inputs.service }}"
              echo "  Environment: ${{ inputs.environment }}"
              echo "  Directory: $SERVICE_DIR"
              echo "  Exists: $([ -d "$SERVICE_DIR" ] && echo "‚úÖ Yes" || echo "‚ùå No")"
              
              if [ -d "$SERVICE_DIR" ]; then
                echo ""
                echo "üìÅ Service Contents:"
                ls -la "$SERVICE_DIR"
                
                # Check for common files
                echo ""
                echo "üîß Configuration:"
                [ -f "$SERVICE_DIR/package.json" ] && echo "  üì¶ Node.js: ‚úÖ" || echo "  üì¶ Node.js: ‚ùå"
                [ -f "$SERVICE_DIR/Dockerfile" ] && echo "  üê≥ Docker: ‚úÖ" || echo "  üê≥ Docker: ‚ùå"
                [ -f "$SERVICE_DIR/requirements.txt" ] && echo "  üêç Python: ‚úÖ" || echo "  üêç Python: ‚ùå"
                [ -f "$SERVICE_DIR/go.mod" ] && echo "  üêπ Go: ‚úÖ" || echo "  üêπ Go: ‚ùå"
                
                # Recent activity
                echo ""
                echo "üìÖ Last Modified: $(stat -c %y "$SERVICE_DIR" 2>/dev/null || echo "Unknown")"
              fi
            else
              # Overall status
              echo "üè¢ Repository Status:"
              echo "  Repository: ${{ github.repository }}"
              echo "  Branch: ${{ github.ref_name }}"
              echo "  SHA: ${{ github.sha }}"
              echo "  Environment: ${{ inputs.environment }}"
              
              echo ""
              echo "üìÅ Available Services:"
              if [ -d "services" ]; then
                ls -la services/
                
                echo ""
                echo "üìä Service Summary:"
                SERVICE_COUNT=$(ls -1d services/*/ 2>/dev/null | wc -l)
                echo "  Total services: $SERVICE_COUNT"
                
                for service in services/*/; do
                  if [ -d "$service" ]; then
                    service_name=$(basename "$service")
                    echo "  - $service_name: $([ -f "$service/package.json" ] && echo "Node.js" || [ -f "$service/Dockerfile" ] && echo "Docker" || echo "Unknown")"
                  fi
                done
              else
                echo "  ‚ùå No services directory found"
              fi
              
              echo ""
              echo "‚ö° Workflow Status:"
              echo "  Run ID: ${{ github.run_id }}"
              echo "  Run Number: ${{ github.run_number }}"
              echo "  Job: ${{ github.job }}"
              echo "  Actor: ${{ github.actor }}"
            fi
          fi
          
          echo "‚úÖ Status check completed successfully!"

      # ===== SUMMARY =====
      - name: Job completion summary
        if: always()
        run: |
          echo ""
          echo "üéØ DevCommandHub Job Summary"
          echo "============================"
          echo "Job ID: ${{ inputs.job_id }}"
          echo "Action: ${{ inputs.action }}"
          echo "Service: ${{ inputs.service }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Status: ${{ job.status }}"
          echo "Duration: ${{ steps.*.outcome }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Operation completed successfully!"
          else
            echo "‚ùå Operation failed - check logs above for details"
          fi